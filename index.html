<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>李医生数字诊室</title>
    <!-- 引入 Coze SDK -->
    <script src="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.19/libs/cn/index.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            display: flex;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* 左侧海报区域 - 75% 宽度 */
        .left-poster {
            width: 75%;
            height: 100%;
            overflow: hidden;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .left-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center right;
        }

        /* 右侧对话框区域 */
        .coze-web-sdk-container {
            right: 0 !important;
            bottom: 0 !important;
            left: auto !important;
            top: 0 !important;
            width: 25% !important;
            height: 100% !important;
            z-index: 1000 !important;
        }

        /* 隐藏气泡按钮 */
        .coze-web-sdk-bubble-icon {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 左侧海报 -->
    <div class="left-poster">
        <img src="https://images.unsplash.com/photo-1629909613654-28e377c37b09?q=80&w=2070&auto=format&fit=crop" alt="诊室预览">
    </div>

    <script>
        // ============================================
        // 配置区域
        // ============================================
        const COZE_CONFIG = {
            botId: '7608863077597626394',
            personalAccessToken: 'pat_dT8ZNCudSDhO2DRLnZMtuuZNhBwOFt4gTbNjr25yPK6FtkC5hK9VmehDLKuSqR7w'
        };

        // ============================================
        // 会话管理：为每个用户/设备生成唯一 ID
        // ============================================
        let userSessionId = localStorage.getItem('dr_chatbot_session_id');

        if (!userSessionId) {
            userSessionId = 'patient_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('dr_chatbot_session_id', userSessionId);
        }

        console.log('=== 李医生数字诊室 ===');
        console.log('会话ID:', userSessionId);
        console.log('提示：不同用户会有不同的会话ID');

        // ============================================
        // 尝试通过 API 创建独立会话
        // ============================================
        async function createConversation() {
            try {
                const response = await fetch('https://api.coze.cn/v1/conversation/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${COZE_CONFIG.personalAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bot_id: COZE_CONFIG.botId,
                        // 尝试用会话 ID 作为会话标识
                        // 注意：这个字段可能不是官方支持的，只是尝试
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ 创建会话成功:', data);
                    return data.data.id;
                } else {
                    console.log('⚠️ API 创建会话失败，使用默认会话');
                    return null;
                }
            } catch (error) {
                console.log('⚠️ 创建会话出错，使用默认会话:', error.message);
                return null;
            }
        }

        // ============================================
        // 初始化 Coze SDK
        // ============================================
        async function initChat() {
            try {
                // 尝试创建会话
                const conversationId = await createConversation();

                const config = {
                    config: {
                        bot_id: COZE_CONFIG.botId
                    },
                    componentProps: {
                        title: '李医生数字诊室',
                        layout: 'pc'
                    },
                    auth: {
                        type: 'token',
                        token: COZE_CONFIG.personalAccessToken,
                        onRefreshToken: () => COZE_CONFIG.personalAccessToken
                    },
                    userInfo: {
                        id: userSessionId,
                        name: '患者'
                    },
                    ui: {
                        asstBtn: {
                            isNeed: false
                        }
                    }
                };

                // 如果创建了会话 ID，尝试传入（可能不支持）
                if (conversationId) {
                    config.config.conversation_id = conversationId;
                }

                const client = new CozeWebSDK.WebChatClient(config);

                console.log('✅ SDK 初始化成功');

                // 自动打开对话框
                setTimeout(() => {
                    if (client.showChatBot) {
                        client.showChatBot();
                        console.log('✅ 对话框已打开');
                    }
                }, 1000);

            } catch (error) {
                console.error('❌ 初始化失败:', error);
                console.error('错误详情:', error.message);
            }
        }

        // 启动
        initChat();

        // ============================================
        // 错误处理
        // ============================================
        window.addEventListener('error', (e) => {
            console.error('发生错误:', e.message);
        });
    </script>
</body>
</html>
